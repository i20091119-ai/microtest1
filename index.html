<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°êµ¬ìš© ë°ì´í„° íŒŒì´í”„ë¼ì¸ - í•™ìƒìš©</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 90%; max-width: 800px; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        canvas { max-height: 300px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
        .stat-card { background: #eee; padding: 10px; border-radius: 8px; }
        .btn-save { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="panel">
        <h2>ğŸ”¬ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘ ë° ìŠ¤íŠ¸ë¦¬ë° ë¶„ì„</h2>
        <div class="controls">
            <button id="btnConnect" style="background:#007bff; color:white; border:none; padding:10px 20px; border-radius:5px;">ê¸°ê¸° ì—°ê²°</button>
            <button id="btnDownload" class="btn-save" disabled>JSONL ë‹¤ìš´ë¡œë“œ</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">í˜„ì¬ ê°€ì†ë„<br><strong id="currAcc">-</strong></div>
            <div class="stat-card">ìµœê·¼ 5ì´ˆ í‰ê· <br><strong id="avgAcc">-</strong></div>
            <div class="stat-card">ì¶©ê²© ì´ë²¤íŠ¸<br><strong id="eventCount">0</strong></div>
        </div>
    </div>

    <div class="panel">
        <canvas id="realtimeChart"></canvas>
    </div>

    <script>
        // [Firebase ì„¤ì • - ë³¸ì¸ ì •ë³´ ìœ ì§€]
        const firebaseConfig = {
            apiKey: "AIzaSyCINokjlLwLlrE8Qa7SzWGm_-B1V5wr0L8",
            databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com",
            projectId: "microbit-lab",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const studentId = prompt("ì—°êµ¬ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", "Researcher_1");

        let sessionLog = []; // JSONLìš© ë°ì´í„° ì €ì¥ì†Œ
        let accWindow = [];  // ì‹¤ì‹œê°„ ë¶„ì„ìš© ìœˆë„ìš° (ìµœê·¼ 50ê°œ ìƒ˜í”Œ)
        let eventCount = 0;

        // --- Chart.js ì„¤ì • ---
        const ctx = document.getElementById('realtimeChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'ê°€ì†ë„(ë³€í™”ìœ¨)', data: [], borderColor: '#007bff', tension: 0.1, pointRadius: 0 }] },
            options: { scales: { y: { min: 500, max: 2500 } }, animation: false }
        });

        async function readLoop(port) {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                let lines = buffer.split("\n");
                buffer = lines.pop();

                for (let line of lines) {
                    try {
                        const raw = JSON.parse(line.trim());
                        
                        // 1. ì‹¤ì‹œê°„ ë¶„ì„ (Moving Average ê³„ì‚°)
                        accWindow.push(raw.acc);
                        if(accWindow.length > 50) accWindow.shift();
                        const avg = accWindow.reduce((a,b)=>a+b, 0) / accWindow.length;

                        // 2. ì´ìƒì¹˜ ê°ì§€ (Event Detection)
                        let isEvent = false;
                        if(raw.acc > 2000) { eventCount++; isEvent = true; }

                        // 3. íŒŒì´í”„ë¼ì¸ í†µí•© ë°ì´í„° ìƒì„±
                        const processedData = {
                            ...raw,
                            analysis: {
                                rolling_avg: avg.toFixed(2),
                                is_impact: isEvent
                            },
                            server_ts: Date.now()
                        };

                        // 4. ìˆ˜ì§‘ (JSONL ë¡œê·¸ ìŒ“ê¸°)
                        sessionLog.push(processedData);
                        document.getElementById('btnDownload').disabled = false;

                        // 5. ì‹œê°í™” ë° UI ì—…ë°ì´íŠ¸
                        updateUI(processedData, avg);
                        
                        // 6. í´ë¼ìš°ë“œ ì „ì†¡
                        db.ref('class/' + studentId).set(processedData);

                    } catch(e) {}
                }
            }
        }

        function updateUI(data, avg) {
            document.getElementById('currAcc').innerText = data.acc;
            document.getElementById('avgAcc').innerText = avg.toFixed(1);
            document.getElementById('eventCount').innerText = eventCount;

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ìµœê·¼ 100ê°œë§Œ í‘œì‹œ)
            chart.data.labels.push("");
            chart.data.datasets[0].data.push(data.acc);
            if(chart.data.labels.length > 100) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();
        }

        // JSONL ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        document.getElementById('btnDownload').onclick = () => {
            const blob = new Blob([sessionLog.map(obj => JSON.stringify(obj)).join('\n')], {type: 'application/jsonl'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `session_${studentId}_${Date.now()}.jsonl`;
            a.click();
        };

        document.getElementById('btnConnect').onclick = async () => {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            readLoop(port);
        };
    </script>
</body>
</html>
