<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PHD Lab - ì‹¤ì‹œê°„ ë¶„ì„ ì‹œìŠ¤í…œ (Optimized)</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; background: #f0f4f8; padding: 20px; color: #333; }
    .panel { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { padding: 15px; border-radius: 12px; text-align: center; color: white; }
    .acc-color { background: #007bff; } .mic-color { background: #6f42c1; } .temp-color { background: #fd7e14; }
    .stat-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; display: block; }
    .stat-main { font-size: 1.8rem; font-weight: 800; display: block; }
    .stat-sub { font-size: 0.9rem; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; display: block; }
    .ai-box { background: #e3f2fd; border-left: 5px solid #1976d2; padding: 15px; border-radius: 8px; font-weight: 500; }
    canvas { max-height: 160px; width: 100% !important; }
    .controls { text-align: center; margin-bottom: 20px; }
    button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button:active { transform: scale(0.95); }
  </style>
</head>
<body>
  <div class="panel">
    <h2 style="text-align:center; margin-top:0;">ğŸ“¡ ë©€í‹°ì„¼ì„œ ì‹¤ì‹œê°„ ë¶„ì„ íŒŒì´í”„ë¼ì¸</h2>
    <div class="controls">
      <button id="btnConnect" style="background:#007bff; color:white;">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°</button>
      <button id="btnDownload" style="background:#28a745; color:white; margin-left:10px;" disabled>ë¡œê·¸ ì €ì¥ (JSONL)</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card acc-color">
        <span class="stat-label">ê°€ì†ë„ (Acc)</span>
        <span class="stat-main" id="curAcc">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgAcc">0.0</span></span>
      </div>
      <div class="stat-card mic-color">
        <span class="stat-label">ì†ŒìŒ (Mic)</span>
        <span class="stat-main" id="curMic">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgMic">0.0</span></span>
      </div>
      <div class="stat-card temp-color">
        <span class="stat-label">ì˜¨ë„ (Temp)</span>
        <span class="stat-main" id="curTemp">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgTemp">0.0</span></span>
      </div>
    </div>

    <div class="ai-box">
      ğŸ¤– <strong>AI Insight:</strong>
      <span id="aiReport" style="font-weight: 400;">(ì„±ëŠ¥ ì•ˆì •í™” í›„ AI ì—°ê²° ì˜ˆì •)</span>
    </div>
  </div>

  <div class="panel"><canvas id="accChart"></canvas></div>
  <div class="panel"><canvas id="micChart"></canvas></div>
  <div class="panel"><canvas id="tempChart"></canvas></div>

  <script>
    /********************
     * 0) ì„±ëŠ¥ íŒŒë¼ë¯¸í„°
     ********************/
    const UI_FPS = 10;                 // UI/ì°¨íŠ¸ ê°±ì‹  ë¹ˆë„ (ì´ˆë‹¹ 10íšŒ)
    const UI_INTERVAL_MS = 1000 / UI_FPS;
    const FIREBASE_INTERVAL_MS = 500;  // Firebase ì „ì†¡ ë¹ˆë„ (ì´ˆë‹¹ 2íšŒ)
    const AVG_WINDOW_SIZE = 50;        // ì•½ 5ì´ˆ (ìƒ˜í”Œë§ì´ ëŒ€ëµ 10Hz~20Hzë©´ ì ë‹¹)
    const CHART_POINTS = 60;           // ì°¨íŠ¸ í¬ì¸íŠ¸ ìˆ˜ (ë„ˆë¬´ í¬ë©´ ë¬´ê±°ì›€)

    /********************
     * 1) ì´ˆê¸° ì„¤ì •
     ********************/
    const firebaseConfig = { databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const studentId = "Researcher_1";

    let sessionLog = [];

    // ìµœì‹ ê°’(ìˆ˜ì‹  ë£¨í”„ëŠ” ì´ ê°’ë§Œ ê°±ì‹ )
    let latestData = { acc: 1000, mic: 0, temp: 25, ts: Date.now() };
    let hasData = false;

    // ë°ì´í„° ëŠê¹€ ì‹œ ë³´ì •ê°’
    let lastValues = { acc: 1000, mic: 0, temp: 25 };

    // ì´ë™í‰ê· ìš©: ring buffer + running sum (O(1))
    const avgState = {
      acc: { buf: new Array(AVG_WINDOW_SIZE).fill(0), idx: 0, filled: 0, sum: 0 },
      mic: { buf: new Array(AVG_WINDOW_SIZE).fill(0), idx: 0, filled: 0, sum: 0 },
      temp:{ buf: new Array(AVG_WINDOW_SIZE).fill(0), idx: 0, filled: 0, sum: 0 }
    };

    function pushAvg(key, value) {
      const s = avgState[key];
      // ì œê±°ë  ê°’
      const old = s.buf[s.idx];
      s.sum -= old;

      // ìƒˆ ê°’ ë„£ê¸°
      s.buf[s.idx] = value;
      s.sum += value;

      s.idx = (s.idx + 1) % AVG_WINDOW_SIZE;
      if (s.filled < AVG_WINDOW_SIZE) s.filled++;

      return s.sum / s.filled;
    }

    /********************
     * 2) ì°¨íŠ¸ ì´ˆê¸°í™” (ìµœì í™”)
     ********************/
    const charts = {};
    function setupCharts() {
      const baseConfig = (label, min, max) => ({
        type: 'line',
        data: {
          labels: new Array(CHART_POINTS).fill(""),
          datasets: [{
            label,
            data: new Array(CHART_POINTS).fill(null),
            tension: 0.2,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          animation: false,
          parsing: false,
          normalized: true,
          maintainAspectRatio: false,
          scales: { y: { min, max }, x: { display: false } },
          plugins: { legend: { display: true } }
        }
      });

      charts.acc = new Chart(document.getElementById('accChart'), baseConfig('ê°€ì†ë„(mg)', 800, 1200));
      charts.mic = new Chart(document.getElementById('micChart'), baseConfig('ì†ŒìŒ(lvl)', 0, 150));
      charts.temp= new Chart(document.getElementById('tempChart'), baseConfig('ì˜¨ë„(Â°C)', 15, 40));
    }
    setupCharts();

    // ì°¨íŠ¸ ë°ì´í„° push (ì‹¤ì œ updateëŠ” UI ë£¨í”„ì—ì„œë§Œ)
    function pushChart(key, value) {
      const arr = charts[key].data.datasets[0].data;
      arr.push(value);
      if (arr.length > CHART_POINTS) arr.shift();
    }

    /********************
     * 3) UI ë£¨í”„: ì´ˆë‹¹ 10íšŒë§Œ ê°±ì‹ 
     ********************/
    let lastUiTick = 0;
    function uiLoop(now) {
      if (now - lastUiTick >= UI_INTERVAL_MS && hasData) {
        lastUiTick = now;

        const d = latestData;

        // í˜„ì¬ê°’ UI
        document.getElementById('curAcc').innerText = Math.round(d.acc);
        document.getElementById('curMic').innerText = Math.round(d.mic);
        document.getElementById('curTemp').innerText = Math.round(d.temp);

        // í‰ê· ê°’ UI (O(1))
        const aAcc  = pushAvg('acc', d.acc);
        const aMic  = pushAvg('mic', d.mic);
        const aTemp = pushAvg('temp', d.temp);

        document.getElementById('avgAcc').innerText  = aAcc.toFixed(1);
        document.getElementById('avgMic').innerText  = aMic.toFixed(1);
        document.getElementById('avgTemp').innerText = aTemp.toFixed(1);

        // ì°¨íŠ¸ ë°ì´í„°ë§Œ ëˆ„ì  í›„, updateëŠ” ì—¬ê¸°ì„œë§Œ 1íšŒì”©
        pushChart('acc', d.acc);
        pushChart('mic', d.mic);
        pushChart('temp', d.temp);

        charts.acc.update('none');
        charts.mic.update('none');
        charts.temp.update('none');
      }
      requestAnimationFrame(uiLoop);
    }
    requestAnimationFrame(uiLoop);

    /********************
     * 4) Firebase ì „ì†¡: ë°°ì¹˜(Throttle)
     ********************/
    let lastFbTime = 0;
    function firebaseTick(now) {
      if (hasData && now - lastFbTime >= FIREBASE_INTERVAL_MS) {
        lastFbTime = now;

        // â€œí˜„ì¬ ìƒíƒœâ€ë§Œ ê°„í—ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ìƒ˜í”Œë§ˆë‹¤ set() ê¸ˆì§€!)
        const d = latestData;
        db.ref(`class/${studentId}/current`).set(d);
      }
      requestAnimationFrame(firebaseTick);
    }
    requestAnimationFrame(firebaseTick);

    /********************
     * 5) Serial ìˆ˜ì‹  ë£¨í”„: ìµœëŒ€í•œ ê°€ë³ê²Œ
     ********************/
    async function readLoop(port) {
      const reader = port.readable.pipeThrough(new TextDecoderStream()).getReader();
      let buffer = "";
      document.getElementById('btnConnect').innerText = "Streaming...";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += value;
        const lines = buffer.split("\n");
        buffer = lines.pop();

        for (const line of lines) {
          const t = line.trim();
          if (!t) continue;

          try {
            const raw = JSON.parse(t);

            // ë³´ì •(0/NaN ì²˜ë¦¬)
            const acc  = (Number(raw.acc)  > 0)  ? Number(raw.acc)  : lastValues.acc;
            const mic  = (Number(raw.mic)  >= 0) ? Number(raw.mic)  : lastValues.mic;
            const temp = (Number(raw.temp) > 0)  ? Number(raw.temp) : lastValues.temp;

            const data = { acc, mic, temp, ts: Date.now() };
            lastValues = { acc, mic, temp };

            // â­ ì—¬ê¸°ì„œëŠ” "ìµœì‹ ê°’"ë§Œ ê°±ì‹  (UI/ì°¨íŠ¸/íŒŒì´ì–´ë² ì´ìŠ¤ëŠ” ë‹¤ë¥¸ ë£¨í”„ê°€ ì²˜ë¦¬)
            latestData = data;
            hasData = true;

            // ë¡œê·¸ëŠ” ë‚¨ê¸°ë˜, ë„ˆë¬´ í° ë¶€ë‹´ì´ë©´ ìƒ˜í”Œë§ë„ ê°€ëŠ¥(ì•„ë˜ ì£¼ì„ ì°¸ê³ )
            sessionLog.push(data);

            document.getElementById('btnDownload').disabled = false;
          } catch (e) {
            // íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ
          }
        }
      }
    }

    /********************
     * 6) ë²„íŠ¼ í•¸ë“¤ëŸ¬
     ********************/
    document.getElementById('btnConnect').onclick = async () => {
      const port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      readLoop(port);
    };

    document.getElementById('btnDownload').onclick = () => {
      const blob = new Blob([sessionLog.map(JSON.stringify).join('\n')], { type: 'application/jsonl' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `PHD_Data_${Date.now()}.jsonl`;
      a.click();
    };

    /********************
     * (ì˜µì…˜) ë¡œê·¸ê°€ ë„ˆë¬´ ì»¤ì§ˆ ë•Œ:
     * - sessionLogë¥¼ â€œëª¨ë“  ìƒ˜í”Œâ€ ëŒ€ì‹  â€œnê°œ ì¤‘ 1ê°œë§Œ ì €ì¥â€ìœ¼ë¡œ ë°”ê¾¸ë©´ ë©”ëª¨ë¦¬ë„ ì•ˆì •ë¨
     * ì˜ˆ) let logEvery = 2; let cnt=0; if(++cnt % logEvery===0) sessionLog.push(data);
     ********************/
  </script>
</body>
</html>
