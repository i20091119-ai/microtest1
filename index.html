<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PHD Lab - ë³´ì•ˆ ê°•í™” AIoT ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f0f4f8; padding: 20px; }
        .panel { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 12px; text-align: center; color: white; }
        .acc-color { background: #007bff; } .mic-color { background: #6f42c1; } .temp-color { background: #fd7e14; }
        .stat-main { font-size: 1.8rem; font-weight: 800; display: block; }
        .stat-sub { font-size: 0.9rem; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; display: block; }
        .ai-box { background: #e3f2fd; border-left: 5px solid #1976d2; padding: 15px; border-radius: 8px; font-weight: 500; }
        canvas { max-height: 160px; width: 100% !important; }
        button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="panel">
        <h2 style="text-align:center;">ğŸ›°ï¸ ë³´ì•ˆ ê°•í™” ì‹¤ì‹œê°„ AIoT ë¶„ì„ê¸°</h2>
        <div style="text-align:center; margin-bottom:20px;">
            <button id="btnConnect">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°</button>
            <button id="btnDownload" style="background:#28a745; margin-left:10px;" disabled>ë°ì´í„° ì €ì¥</button>
        </div>
        <div class="stats-grid">
            <div class="stat-card acc-color"><span class="stat-main" id="curAcc">0</span><span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgAcc">0.0</span></span></div>
            <div class="stat-card mic-color"><span class="stat-main" id="curMic">0</span><span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgMic">0.0</span></span></div>
            <div class="stat-card temp-color"><span class="stat-main" id="curTemp">0</span><span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgTemp">0.0</span></span></div>
        </div>
        <div class="ai-box">ğŸ¤– <strong>AI ë¶„ì„:</strong> <span id="aiReport">ê¸°ê¸° ì—°ê²° ì‹œ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</span></div>
    </div>
    <div class="panel"><canvas id="accChart"></canvas></div>
    <div class="panel"><canvas id="micChart"></canvas></div>
    <div class="panel"><canvas id="tempChart"></canvas></div>

    <script>
        const firebaseConfig = { databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com" };
        const CLOUD_FUNCTION_URL = "https://asia-northeast3-microbit-lab.cloudfunctions.net/aiSummary";
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const studentId = "Researcher_1"; 

        let sessionLog = [];
        let windows = { acc: [], mic: [], temp: [] };
        let lastValues = { acc: 1000, mic: 0, temp: 25 };
        
        // AI ê´€ë ¨ ì œì–´ ë³€ìˆ˜
        let lastAiTime = 0;
        let isAiProcessing = false;
        let isFirstRun = true; // [ì¶”ê°€] ìµœì´ˆ ì‹¤í–‰ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

        const charts = {};
        function setupCharts() {
            const config = (label, color, min, max) => ({
                type: 'line',
                data: { labels: new Array(40).fill(""), datasets: [{ label, data: new Array(40).fill(null), borderColor: color, tension: 0.2, pointRadius: 0, borderWidth: 2 }] },
                options: { responsive: true, animation: false, maintainAspectRatio: false, scales: { y: { min, max } }, x: { display: false } }
            });
            charts.acc = new Chart(document.getElementById('accChart'), config('ê°€ì†ë„', '#007bff', 800, 1200));
            charts.mic = new Chart(document.getElementById('micChart'), config('ì†ŒìŒ', '#6f42c1', 0, 150));
            charts.temp = new Chart(document.getElementById('tempChart'), config('ì˜¨ë„', '#fd7e14', 15, 40));
        }
        setupCharts();

        async function runAI(data) {
            // [ìˆ˜ì •] ìµœì´ˆ ì‹¤í–‰ì€ 10ì´ˆ ëŒ€ê¸°, ê·¸ ì´í›„ëŠ” 30ì´ˆ ëŒ€ê¸° ë¡œì§ ì ìš©
            const waitTime = isFirstRun ? 10000 : 30000;
            
            if (Date.now() - lastAiTime < waitTime || isAiProcessing) return; 
            
            isAiProcessing = true;
            lastAiTime = Date.now();
            document.getElementById('aiReport').innerText = "ì„œë²„ì—ì„œ AI ë¶„ì„ ì¤‘...";

            try {
                const response = await fetch(CLOUD_FUNCTION_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ acc: data.acc, mic: data.mic, temp: data.temp })
                });
                const result = await response.json();
                document.getElementById('aiReport').innerText = result.summary;
                db.ref(`class/${studentId}/ai_comment`).set(result.summary);
                
                // [ì¶”ê°€] ì„±ê³µì ìœ¼ë¡œ ì²« ë¶„ì„ì´ ì™„ë£Œë˜ë©´ í”Œë˜ê·¸ë¥¼ falseë¡œ ë³€ê²½
                isFirstRun = false; 
                
            } catch (e) {
                document.getElementById('aiReport').innerText = "AI ì„œë¹„ìŠ¤ ì¼ì‹œ ëŒ€ê¸° ì¤‘...";
            } finally { isAiProcessing = false; }
        }

        async function readLoop(port) {
            const reader = port.readable.pipeThrough(new TextDecoderStream()).getReader();
            let buffer = "";
            document.getElementById('btnConnect').innerText = "ë°ì´í„° ìˆ˜ì§‘ ì¤‘";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                let lines = buffer.split("\n");
                buffer = lines.pop();

                for (let line of lines) {
                    try {
                        const raw = JSON.parse(line.trim());
                        const data = {
                            acc: (Number(raw.acc) > 0) ? Number(raw.acc) : lastValues.acc,
                            mic: (Number(raw.mic) >= 0) ? Number(raw.mic) : lastValues.mic,
                            temp: (Number(raw.temp) > 0) ? Number(raw.temp) : lastValues.temp,
                            ts: Date.now()
                        };
                        lastValues = { ...data };

                        ['acc', 'mic', 'temp'].forEach(k => {
                            windows[k].push(data[k]);
                            if(windows[k].length > 50) windows[k].shift();
                            const avg = (windows[k].reduce((a,b)=>a+b,0) / windows[k].length).toFixed(1);
                            document.getElementById('cur'+k.charAt(0).toUpperCase()+k.slice(1)).innerText = Math.round(data[k]);
                            document.getElementById('avg'+k.charAt(0).toUpperCase()+k.slice(1)).innerText = avg;
                            charts[k].data.datasets[0].data.push(data[k]);
                            charts[k].data.datasets[0].data.shift();
                            charts[k].update('none');
                        });

                        sessionLog.push(data);
                        db.ref(`class/${studentId}/current`).set(data);
                        runAI(data);
                        document.getElementById('btnDownload').disabled = false;
                    } catch(e) {}
                }
            }
        }

        document.getElementById('btnConnect').onclick = async () => {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            readLoop(port);
        };

        document.getElementById('btnDownload').onclick = () => {
            const blob = new Blob([sessionLog.map(JSON.stringify).join('\n')], {type: 'application/jsonl'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `PHD_secure_log_${Date.now()}.jsonl`;
            a.click();
        };
    </script>
</body>
</html>
