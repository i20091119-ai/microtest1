<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PHD Lab - ë³´ì•ˆ ê°•í™” AIoT ì‹œìŠ¤í…œ (5ì´ˆ í‰ê· +ì¶”ì„¸ ì „ì†¡)</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; background: #f0f4f8; padding: 20px; }
    .panel { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { padding: 15px; border-radius: 12px; text-align: center; color: white; }
    .acc-color { background: #007bff; } .mic-color { background: #6f42c1; } .temp-color { background: #fd7e14; }
    .stat-main { font-size: 1.8rem; font-weight: 800; display: block; }
    .stat-sub { font-size: 0.9rem; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; display: block; }
    .ai-box { background: #e3f2fd; border-left: 5px solid #1976d2; padding: 15px; border-radius: 8px; font-weight: 500; }
    canvas { max-height: 160px; width: 100% !important; }
    button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #007bff; color: white; }
    #btnDownload { background:#28a745; margin-left:10px; }
  </style>
</head>
<body>
  <div class="panel">
    <h2 style="text-align:center;">ğŸ›°ï¸ ë³´ì•ˆ ê°•í™” ì‹¤ì‹œê°„ AIoT ë¶„ì„ê¸°</h2>
    <div style="text-align:center; margin-bottom:20px;">
      <button id="btnConnect">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°</button>
      <button id="btnDownload" disabled>ë°ì´í„° ì €ì¥</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card acc-color">
        <span class="stat-main" id="curAcc">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgAcc">0.0</span> / ì¶”ì„¸: <span id="trAcc">-</span></span>
      </div>
      <div class="stat-card mic-color">
        <span class="stat-main" id="curMic">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgMic">0.0</span> / ì¶”ì„¸: <span id="trMic">-</span></span>
      </div>
      <div class="stat-card temp-color">
        <span class="stat-main" id="curTemp">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgTemp">0.0</span> / ì¶”ì„¸: <span id="trTemp">-</span></span>
      </div>
    </div>

    <div class="ai-box">
      ğŸ¤– <strong>AI ë¶„ì„:</strong>
      <span id="aiReport">ê¸°ê¸° ì—°ê²° ì‹œ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</span>
    </div>
  </div>

  <div class="panel"><canvas id="accChart"></canvas></div>
  <div class="panel"><canvas id="micChart"></canvas></div>
  <div class="panel"><canvas id="tempChart"></canvas></div>

<script>
  // =========================
  // 0) ì„±ëŠ¥/ì£¼ê¸°(Throttle) ì„¤ì •
  // =========================
  const UI_INTERVAL_MS       = 100;    // UI 10Hz
  const CHART_INTERVAL_MS    = 200;    // ì°¨íŠ¸ 5Hz
  const FIREBASE_INTERVAL_MS = 1000;   // Firebase 1Hz
  const AI_INTERVAL_MS       = 20000;  // AI 20ì´ˆ (ì›í•˜ë©´ 30ì´ˆë¡œ)
  const WINDOW_MS            = 5000;   // âœ… ìµœê·¼ 5ì´ˆ

  // =========================
  // 1) ì´ˆê¸° ì„¤ì •
  // =========================
  const firebaseConfig = { databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com" };
  const CLOUD_FUNCTION_URL = "https://aisummary-pn6mgvc5aq-du.a.run.app"; // âœ… ë³¸ì¸ í•¨ìˆ˜ URL

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const studentId = "Researcher_1"; // âœ… í•„ìš”ì‹œ ë³€ê²½

  // =========================
  // 2) ìƒíƒœ ë³€ìˆ˜
  // =========================
  let sessionLog = [];
  let latestData = null;
  let lastGood = { acc: 1000, mic: 0, temp: 25, ts: Date.now() };

  // ìµœê·¼ 5ì´ˆ ë²„í¼(ì‹œê°„ ê¸°ë°˜)
  const buffer = { acc: [], mic: [], temp: [] }; // each: [{t, v}, ...]

  // AI í˜¸ì¶œ ì œì–´
  let lastAiTime = 0;
  let aiBusy = false;

  // =========================
  // 3) ì°¨íŠ¸ ì´ˆê¸°í™”
  // =========================
  const charts = {};
  const chartLen = 40;

  function setupCharts() {
    const mk = (label, color, min, max, elId) => new Chart(document.getElementById(elId), {
      type: 'line',
      data: {
        labels: new Array(chartLen).fill(""),
        datasets: [{
          label,
          data: new Array(chartLen).fill(null),
          borderColor: color,
          tension: 0.2,
          pointRadius: 0,
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        animation: false,
        maintainAspectRatio: false,
        scales: { y: { min, max }, x: { display: false } }
      }
    });

    charts.acc  = mk('ê°€ì†ë„', '#007bff', 800, 1200, 'accChart');
    charts.mic  = mk('ì†ŒìŒ',   '#6f42c1', 0,   150,  'micChart');
    charts.temp = mk('ì˜¨ë„',   '#fd7e14', 15,  40,   'tempChart');
  }
  setupCharts();

  // =========================
  // 4) ìµœê·¼ 5ì´ˆ í†µê³„ ê³„ì‚°
  // =========================
  function pruneOld(key, now) {
    const arr = buffer[key];
    while (arr.length && (now - arr[0].t) > WINDOW_MS) arr.shift();
  }

  function pushToBuffer(key, v, t) {
    buffer[key].push({ t, v });
    pruneOld(key, t);
  }

  function calcAvg(key) {
    const arr = buffer[key];
    if (!arr.length) return null;
    let sum = 0;
    for (const p of arr) sum += p.v;
    return sum / arr.length;
  }

  // ì¶”ì„¸: ìµœê·¼ 5ì´ˆì—ì„œ "ì²˜ìŒê°’â†’ë§ˆì§€ë§‰ê°’" ë³€í™”ëŸ‰ìœ¼ë¡œ íŒë‹¨
  // (ë…¸ì´ì¦ˆê°€ ì‹¬í•˜ë©´ ì„ í˜•íšŒê·€ë¡œ ë°”ê¿€ ìˆ˜ë„ ìˆëŠ”ë°, ì§€ê¸ˆì€ ë‹¨ìˆœ/ì•ˆì •í˜•)
  function calcTrend(key) {
    const arr = buffer[key];
    if (arr.length < 2) return { label: "-", delta: 0 };

    const first = arr[0].v;
    const last  = arr[arr.length - 1].v;
    const delta = last - first;

    // ì„¼ì„œë³„ ì„ê³„ê°’(ë„ˆë¬´ ë¯¼ê°í•˜ë©´ í‚¤ìš°ë©´ ë¨)
    const thr = (key === 'temp') ? 0.5 : (key === 'mic') ? 5 : 15;

    let label = "ì•ˆì •";
    if (delta > thr) label = "ìƒìŠ¹";
    else if (delta < -thr) label = "í•˜ë½";

    return { label, delta };
  }

  function round1(x) { return Math.round(x * 10) / 10; }

  // =========================
  // 5) Serial ì½ê¸°(íŒŒì‹±) ë£¨í”„: ìµœì‹ ê°’/ë¡œê·¸/ë²„í¼ë§Œ ê°±ì‹ 
  // =========================
  async function readLoop(port) {
    const reader = port.readable.pipeThrough(new TextDecoderStream()).getReader();
    let bufferStr = "";
    document.getElementById('btnConnect').innerText = "ë°ì´í„° ìˆ˜ì§‘ ì¤‘";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      bufferStr += value;

      const lines = bufferStr.split("\n");
      bufferStr = lines.pop();

      for (const line of lines) {
        const s = line.trim();
        if (!s) continue;

        try {
          const raw = JSON.parse(s);

          const acc  = (Number(raw.acc)  > 0) ? Number(raw.acc)  : lastGood.acc;
          const mic  = (Number(raw.mic) >= 0) ? Number(raw.mic)  : lastGood.mic;
          const temp = (Number(raw.temp) > 0) ? Number(raw.temp) : lastGood.temp;

          const now = Date.now();
          const data = { acc, mic, temp, ts: now };

          lastGood = data;
          latestData = data;
          sessionLog.push(data);

          // âœ… ìµœê·¼ 5ì´ˆ ë²„í¼ì— ëˆ„ì 
          pushToBuffer('acc',  acc,  now);
          pushToBuffer('mic',  mic,  now);
          pushToBuffer('temp', temp, now);

          document.getElementById('btnDownload').disabled = false;
        } catch (e) {
          // íŒŒì‹± ì‹¤íŒ¨ ë¼ì¸ì€ ë¬´ì‹œ
        }
      }
    }
  }

  // =========================
  // 6) UI ì—…ë°ì´íŠ¸(10Hz)
  // =========================
  setInterval(() => {
    if (!latestData) return;

    const { acc, mic, temp, ts } = latestData;

    // í˜„ì¬ê°’
    document.getElementById('curAcc').innerText  = Math.round(acc);
    document.getElementById('curMic').innerText  = Math.round(mic);
    document.getElementById('curTemp').innerText = Math.round(temp);

    // 5ì´ˆ í‰ê· 
    const aAvg = calcAvg('acc');  const mAvg = calcAvg('mic');  const tAvg = calcAvg('temp');
    document.getElementById('avgAcc').innerText  = (aAvg == null) ? "-" : aAvg.toFixed(1);
    document.getElementById('avgMic').innerText  = (mAvg == null) ? "-" : mAvg.toFixed(1);
    document.getElementById('avgTemp').innerText = (tAvg == null) ? "-" : tAvg.toFixed(1);

    // 5ì´ˆ ì¶”ì„¸
    const aTr = calcTrend('acc'); const mTr = calcTrend('mic'); const tTr = calcTrend('temp');
    document.getElementById('trAcc').innerText  = `${aTr.label}(${Math.round(aTr.delta)})`;
    document.getElementById('trMic').innerText  = `${mTr.label}(${Math.round(mTr.delta)})`;
    document.getElementById('trTemp').innerText = `${tTr.label}(${round1(tTr.delta)})`;
  }, UI_INTERVAL_MS);

  // =========================
  // 7) ì°¨íŠ¸ ì—…ë°ì´íŠ¸(5Hz)
  // =========================
  setInterval(() => {
    if (!latestData) return;

    const upd = (key, v) => {
      const ds = charts[key].data.datasets[0].data;
      ds.push(v);
      if (ds.length > chartLen) ds.shift();
      charts[key].update('none');
    };

    upd('acc', latestData.acc);
    upd('mic', latestData.mic);
    upd('temp', latestData.temp);
  }, CHART_INTERVAL_MS);

  // =========================
  // 8) Firebase ì „ì†¡(1Hz)
  // =========================
  setInterval(() => {
    if (!latestData) return;
    db.ref(`class/${studentId}/current`).set(latestData);
  }, FIREBASE_INTERVAL_MS);

  // =========================
  // 9) AI í˜¸ì¶œ(20ì´ˆ) - âœ… í˜„ì¬ê°’ + 5ì´ˆ í‰ê·  + ì¶”ì„¸(ë³€í™”ëŸ‰) ì „ì†¡
  // =========================
  async function callAI(payload) {
    const response = await fetch(CLOUD_FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    return await response.json();
  }

  setInterval(async () => {
    if (!latestData) return;
    if (aiBusy) return;
    if (Date.now() - lastAiTime < AI_INTERVAL_MS) return;

    // ë²„í¼ê°€ ì¶©ë¶„íˆ ìŒ“ì˜€ì„ ë•Œë§Œ(ìµœì†Œ 2ê°œ)
    if (buffer.acc.length < 2 || buffer.mic.length < 2 || buffer.temp.length < 2) return;

    aiBusy = true;
    lastAiTime = Date.now();
    document.getElementById('aiReport').innerText = "ì„œë²„ì—ì„œ AI ë¶„ì„ ì¤‘...";

    try {
      const aAvg = calcAvg('acc'), mAvg = calcAvg('mic'), tAvg = calcAvg('temp');
      const aTr = calcTrend('acc'), mTr = calcTrend('mic'), tTr = calcTrend('temp');

      const payload = {
        // í˜„ì¬ê°’
        acc: latestData.acc,
        mic: latestData.mic,
        temp: latestData.temp,

        // âœ… ìµœê·¼ 5ì´ˆ í‰ê· 
        avg5s: {
          acc: (aAvg == null) ? null : round1(aAvg),
          mic: (mAvg == null) ? null : round1(mAvg),
          temp:(tAvg == null) ? null : round1(tAvg),
        },

        // âœ… ìµœê·¼ 5ì´ˆ ì¶”ì„¸(ë¼ë²¨ + ë³€í™”ëŸ‰)
        trend5s: {
          acc:  { label: aTr.label,  delta: Math.round(aTr.delta) },
          mic:  { label: mTr.label,  delta: Math.round(mTr.delta) },
          temp: { label: tTr.label,  delta: round1(tTr.delta) },
        },

        // ë©”íƒ€
        windowMs: WINDOW_MS,
        n5s: {
          acc: buffer.acc.length,
          mic: buffer.mic.length,
          temp: buffer.temp.length,
        },
        ts: Date.now(),
      };

      const result = await callAI(payload);

      const summary = (result && result.summary) ? result.summary : "AI ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.";
      document.getElementById('aiReport').innerText = summary;
      db.ref(`class/${studentId}/ai_comment`).set(summary);

    } catch (e) {
      document.getElementById('aiReport').innerText = "AI ì„œë¹„ìŠ¤ ì¼ì‹œ ëŒ€ê¸° ì¤‘...";
    } finally {
      aiBusy = false;
    }
  }, 500); // ë‚´ë¶€ íƒ€ì´ë¨¸ëŠ” 0.5ì´ˆë§ˆë‹¤ ì¡°ê±´ ì²´í¬ (ì‹¤ì œ í˜¸ì¶œì€ AI_INTERVAL_MSë¡œ ì œí•œ)

  // =========================
  // 10) ì—°ê²° ë²„íŠ¼
  // =========================
  document.getElementById('btnConnect').onclick = async () => {
    const port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    readLoop(port);
  };

  // =========================
  // 11) JSONL ì €ì¥
  // =========================
  document.getElementById('btnDownload').onclick = () => {
    const blob = new Blob([sessionLog.map(JSON.stringify).join('\n')], { type: 'application/jsonl' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `PHD_secure_log_${Date.now()}.jsonl`;
    a.click();
  };
</script>
</body>
</html>
