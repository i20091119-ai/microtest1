<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í¬ë¡œë¹„íŠ¸ í•™ìƒìš© ìˆ˜ì§‘ê¸°</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; text-align: center; background: #f0f2f5; padding: 50px; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 8px; transition: 0.3s; }
        button:hover { background: #0056b3; }
        #status { margin-top: 20px; font-weight: bold; color: #dc3545; }
        .data-view { margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ë§ˆì´í¬ë¡œë¹„íŠ¸ ë°ì´í„° ì†¡ì‹ ê¸°</h1>
        <p>ì´ë¦„: <span id="userName">ì—°ê²° ì „</span></p>
        <button id="btnConnect">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°í•˜ê¸°</button>
        <div id="status">ìƒíƒœ: ì—°ê²° ì•ˆ ë¨</div>
        <div class="data-view" id="lastData">ìµœì‹  ë°ì´í„°: ì—†ìŒ</div>
    </div>

    <script>
        // 1. Firebase ì„¤ì • (ë°©ê¸ˆ ë°œê¸‰ë°›ìœ¼ì‹  ì •ë³´ë¡œ êµì²´ ì™„ë£Œ)
        const firebaseConfig = {
            apiKey: "AIzaSyCINokjlLwLlrE8Qa7SzWGm_-B1V5wr0L8",
            authDomain: "microbit-lab.firebaseapp.com",
            databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com",
            projectId: "microbit-lab",
            storageBucket: "microbit-lab.firebasestorage.app",
            messagingSenderId: "688134998676",
            appId: "1:688134998676:web:ffb0f36fc1de86a61d4281"
        };

        // 2. Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 3. ì‚¬ìš©ì ì´ë¦„ ì…ë ¥
        const studentId = prompt("ë³¸ì¸ì˜ ì´ë¦„ì´ë‚˜ ì¢Œì„ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "í•™ìƒ1");
        document.getElementById('userName').innerText = studentId;

        let port, reader;

        // 4. ì—°ê²° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('btnConnect').onclick = async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                document.getElementById('status').innerText = "ìƒíƒœ: ì—°ê²°ë¨ âœ…";
                document.getElementById('status').style.color = "green";
                document.getElementById('btnConnect').style.display = "none";
                
                readLoop();
            } catch (e) {
                console.error(e);
                alert("ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í¬ë¡¬ ë¸Œë¼ìš°ì €ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!");
            }
        };

        // 5. ë°ì´í„° ì½ê¸° ë° Firebase ì „ì†¡ ë£¨í”„
        async function readLoop() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                buffer += value;
                let lines = buffer.split("\n");
                buffer = lines.pop();

                for (let line of lines) {
                    try {
                        const cleanLine = line.trim();
                        if (!cleanLine) continue;
                        
                        const data = JSON.parse(cleanLine);
                        document.getElementById('lastData').innerText = "ìµœì‹  ë°ì´í„°: " + cleanLine;

                        // Firebaseì— ì „ì†¡
                        db.ref('class/' + studentId).set({
                            ...data,
                            lastUpdate: Date.now()
                        });
                    } catch(e) {
                        // íŒŒì‹± ì—ëŸ¬ëŠ” ë¬´ì‹œ
                    }
                }
            }
        }
    </script>
</body>
</html>