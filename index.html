<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë©€í‹°ì„¼ì„œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ - í•™ìƒìš©</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; padding: 20px; color: #333; }
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 95%; max-width: 900px; margin: 0 auto 20px; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 10px; text-align: center; color: white; }
        .acc-color { background: #007bff; } .mic-color { background: #6f42c1; } .temp-color { background: #fd7e14; }
        .stat-val { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; opacity: 0.9; }
        canvas { max-height: 200px; margin-top: 10px; }
        .controls { text-align: center; margin-bottom: 20px; }
        button { padding: 10px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="panel">
        <h2 style="text-align:center;">ğŸ”¬ ì‹¤ì‹œê°„ ë©€í‹°ì„¼ì„œ ìŠ¤íŠ¸ë¦¬ë° ë¶„ì„</h2>
        <div class="controls">
            <button id="btnConnect" style="background:#007bff; color:white;">ê¸°ê¸° ì—°ê²°</button>
            <button id="btnDownload" style="background:#28a745; color:white;" disabled>JSONL ë‹¤ìš´ë¡œë“œ</button>
        </div>
        
        <div class="stats-row">
            <div class="stat-card acc-color">
                <span class="stat-label">ê°€ì†ë„ (5s Avg)</span>
                <span class="stat-val" id="avgAcc">0</span>
                <small>í˜„ì¬: <span id="curAcc">0</span></small>
            </div>
            <div class="stat-card mic-color">
                <span class="stat-label">ì†ŒìŒ (5s Avg)</span>
                <span class="stat-val" id="avgMic">0</span>
                <small>í˜„ì¬: <span id="curMic">0</span></small>
            </div>
            <div class="stat-card temp-color">
                <span class="stat-label">ì˜¨ë„ (5s Avg)</span>
                <span class="stat-val" id="avgTemp">0</span>
                <small>í˜„ì¬: <span id="curTemp">0</span></small>
            </div>
        </div>
    </div>

    <div class="panel"><canvas id="accChart"></canvas></div>
    <div class="panel"><canvas id="micChart"></canvas></div>
    <div class="panel"><canvas id="tempChart"></canvas></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCINokjlLwLlrE8Qa7SzWGm_-B1V5wr0L8",
            databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com",
            projectId: "microbit-lab",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const studentId = prompt("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", "User_1");

        let sessionLog = [];
        let windows = { acc: [], mic: [], temp: [] };

        // ê³µí†µ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
        function createChart(id, label, color, min, max) {
            return new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: new Array(50).fill(""), datasets: [{ label: label, data: [], borderColor: color, tension: 0.2, pointRadius: 0 }] },
                options: { scales: { y: { min, max } }, animation: false, plugins: { legend: { display: true } } }
            });
        }

        const charts = {
            acc: createChart('accChart', 'ê°€ì†ë„ (mg)', '#007bff', 500, 2500),
            mic: createChart('micChart', 'ì†ŒìŒ (level)', '#6f42c1', 0, 255),
            temp: createChart('tempChart', 'ì˜¨ë„ (Â°C)', '#fd7e14', 10, 40)
        };

        async function readLoop(port) {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                let lines = buffer.split("\n");
                buffer = lines.pop();

                for (let line of lines) {
                    try {
                        const raw = JSON.parse(line.trim());
                        const processed = { ...raw, analysis: {}, ts: Date.now() };

                        ['acc', 'mic', 'temp'].forEach(key => {
                            windows[key].push(raw[key]);
                            if(windows[key].length > 50) windows[key].shift();
                            const avg = windows[key].reduce((a,b)=>a+b,0) / windows[key].length;
                            processed.analysis[key + '_avg'] = avg.toFixed(2);
                            
                            // UI & Chart ì—…ë°ì´íŠ¸
                            document.getElementById('cur'+key.charAt(0).toUpperCase()+key.slice(1)).innerText = raw[key];
                            document.getElementById('avg'+key.charAt(0).toUpperCase()+key.slice(1)).innerText = avg.toFixed(1);
                            
                            charts[key].data.datasets[0].data.push(raw[key]);
                            if(charts[key].data.datasets[0].data.length > 50) charts[key].data.datasets[0].data.shift();
                            charts[key].update();
                        });

                        sessionLog.push(processed);
                        db.ref('class/' + studentId).set(processed);
                        document.getElementById('btnDownload').disabled = false;
                    } catch(e) {}
                }
            }
        }

        document.getElementById('btnConnect').onclick = async () => {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            readLoop(port);
        };

        document.getElementById('btnDownload').onclick = () => {
            const blob = new Blob([sessionLog.map(obj => JSON.stringify(obj)).join('\n')], {type: 'application/jsonl'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `research_data_${studentId}.jsonl`; a.click();
        };
    </script>
</body>
</html>
