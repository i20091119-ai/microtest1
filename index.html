<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Lab - ë³´ì•ˆ ê°•í™” AIoT ì‹œìŠ¤í…œ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; background: #f0f4f8; padding: 20px; }
    .panel { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { padding: 15px; border-radius: 12px; text-align: center; color: white; }
    .acc-color { background: #007bff; } .mic-color { background: #6f42c1; } .temp-color { background: #fd7e14; }
    .stat-main { font-size: 1.8rem; font-weight: 800; display: block; }
    .stat-sub { font-size: 0.9rem; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; display: block; }
    .ai-box { background: #e3f2fd; border-left: 5px solid #1976d2; padding: 15px; border-radius: 8px; font-weight: 500; white-space: pre-line; }
    canvas { max-height: 160px; width: 100% !important; }
    button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #007bff; color: white; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-green { background:#28a745; }
    .btn-gray { background:#6c757d; }
  </style>
</head>
<body>
  <div class="panel">
    <h2 style="text-align:center;">ğŸ›°ï¸ ë³´ì•ˆ ê°•í™” ì‹¤ì‹œê°„ AIoT ë¶„ì„ê¸°</h2>
    <div style="text-align:center; margin-bottom:20px;">
      <button id="btnConnect">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°</button>
      <button id="btnDownload" class="btn-green" style="margin-left:10px;" disabled>ë°ì´í„° ì €ì¥</button>
      <button id="btnAiRefresh" class="btn-gray" style="margin-left:10px;" disabled>AI ìš”ì•½ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card acc-color">
        <span class="stat-main" id="curAcc">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgAcc">0.0</span></span>
      </div>
      <div class="stat-card mic-color">
        <span class="stat-main" id="curMic">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgMic">0.0</span></span>
      </div>
      <div class="stat-card temp-color">
        <span class="stat-main" id="curTemp">0</span>
        <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgTemp">0.0</span></span>
      </div>
    </div>

    <div class="ai-box">ğŸ¤– <strong>AI ë¶„ì„:</strong> <span id="aiReport">ê¸°ê¸° ì—°ê²° ì‹œ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</span></div>
  </div>

  <div class="panel"><canvas id="accChart"></canvas></div>
  <div class="panel"><canvas id="micChart"></canvas></div>
  <div class="panel"><canvas id="tempChart"></canvas></div>

  <script>
    // ===== ì„¤ì • =====
    const firebaseConfig = { databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com" };
    const CLOUD_FUNCTION_URL = "https://aisummary-pn6mgvc5aq-du.a.run.app"; // aiSummary URL

    const AVG_WINDOW_SIZE = 50;  // ì•½ 5~8ì´ˆ ëŠë‚Œ(ìƒ˜í”Œë ˆì´íŠ¸ì— ë”°ë¼)
    const CHART_LEN = 40;

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const studentId = "Researcher_1";

    // ===== ìƒíƒœ =====
    let sessionLog = [];
    let windows = { acc: [], mic: [], temp: [] };
    let lastValues = { acc: 1000, mic: 0, temp: 25 };

    let latestData = null;

    // AI í˜¸ì¶œ ì œì–´: ìë™ 1íšŒ + ë²„íŠ¼
    let aiBusy = false;
    let autoAiTimer = null;
    let autoAiDone = false; // âœ… ìë™ìš”ì•½ 1íšŒë§Œ ë³´ì¥

    // ===== ìœ í‹¸ =====
    function calcAvg(arr) {
      if (!arr.length) return 0;
      return arr.reduce((a,b)=>a+b,0) / arr.length;
    }

    // ë°˜ìœ¼ë¡œ ë‚˜ëˆ ì„œ (ì§ì „ ë°˜ í‰ê·  vs ìµœê·¼ ë°˜ í‰ê· )
    function calcSplitStats(arr) {
      if (arr.length < 10) {
        return { prevAvg: null, curAvg: null, delta: 0, trend: "flat" };
      }
      const mid = Math.floor(arr.length / 2);
      const prevAvg = calcAvg(arr.slice(0, mid));
      const curAvg  = calcAvg(arr.slice(mid));
      const delta = curAvg - prevAvg;

      // ì„ê³„ê°’(ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      const eps = Math.max(0.5, Math.abs(prevAvg) * 0.01);
      let trend = "flat";
      if (delta > eps) trend = "up";
      else if (delta < -eps) trend = "down";

      return { prevAvg, curAvg, delta, trend };
    }

    // ===== ì°¨íŠ¸ =====
    const charts = {};
    function setupCharts() {
      const config = (label, color, min, max) => ({
        type: 'line',
        data: {
          labels: new Array(CHART_LEN).fill(""),
          datasets: [{
            label,
            data: new Array(CHART_LEN).fill(null),
            borderColor: color,
            tension: 0.2,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          animation: false,
          maintainAspectRatio: false,
          scales: { y: { min, max }, x: { display: false } }
        }
      });
      charts.acc  = new Chart(document.getElementById('accChart'),  config('ê°€ì†ë„', '#007bff', 800, 1200));
      charts.mic  = new Chart(document.getElementById('micChart'),  config('ì†ŒìŒ',   '#6f42c1', 0,   150));
      charts.temp = new Chart(document.getElementById('tempChart'), config('ì˜¨ë„',   '#fd7e14', 15,  40));
    }
    setupCharts();

    function chartPush(key, v) {
      const ds = charts[key].data.datasets[0].data;
      ds.push(v);
      if (ds.length > CHART_LEN) ds.shift();
      charts[key].update('none');
    }

    // ===== AI ìš”ì²­ payload ë§Œë“¤ê¸° =====
    function buildAiPayload() {
      if (!latestData) return null;

      const sAcc  = calcSplitStats(windows.acc);
      const sMic  = calcSplitStats(windows.mic);
      const sTemp = calcSplitStats(windows.temp);

      const avg5 = {
        acc: Number(calcAvg(windows.acc).toFixed(1)),
        mic: Number(calcAvg(windows.mic).toFixed(1)),
        temp: Number(calcAvg(windows.temp).toFixed(1)),
      };

      const trend = {
        acc: sAcc.trend,
        mic: sMic.trend,
        temp: sTemp.trend,
      };

      // âœ… í•µì‹¬: ìˆ«ì ì¦ê°ë„ í•¨ê»˜ ì „ë‹¬
      const deltaAvg = {
        acc: Number(sAcc.delta.toFixed(1)),
        mic: Number(sMic.delta.toFixed(1)),
        temp: Number(sTemp.delta.toFixed(1)),
      };

      return {
        cur: {
          acc: Math.round(latestData.acc),
          mic: Math.round(latestData.mic),
          temp: Math.round(latestData.temp),
        },
        avg5,
        trend,
        deltaAvg,
        meta: { windowSec: 5, ts: Date.now() }
      };
    }

    async function requestAiSummary() {
      const payload = buildAiPayload();
      if (!payload || aiBusy) return;

      aiBusy = true;
      document.getElementById('aiReport').innerText = "ì„œë²„ì—ì„œ AI ë¶„ì„ ì¤‘...";

      try {
        const resp = await fetch(CLOUD_FUNCTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const json = await resp.json();
        document.getElementById('aiReport').innerText = json.summary || "ìš”ì•½ì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

        // Firebaseì— ì €ì¥(ì›í•˜ë©´ ë„ê¸° ê°€ëŠ¥)
        db.ref(`class/${studentId}/ai_comment`).set(json.summary || "");
      } catch (e) {
        document.getElementById('aiReport').innerText = "AI ì„œë¹„ìŠ¤ ì¼ì‹œ ëŒ€ê¸° ì¤‘...";
      } finally {
        aiBusy = false;
      }
    }

    // ===== Serial readLoop =====
    async function readLoop(port) {
      const reader = port.readable.pipeThrough(new TextDecoderStream()).getReader();
      let buffer = "";

      document.getElementById('btnConnect').innerText = "ë°ì´í„° ìˆ˜ì§‘ ì¤‘";
      document.getElementById('btnAiRefresh').disabled = false;

      // âœ… ì—°ê²° í›„ 10ì´ˆ ë’¤ ìë™ ìš”ì•½ "ë”± 1íšŒ"
      if (autoAiTimer) clearTimeout(autoAiTimer);
      autoAiTimer = setTimeout(() => {
        if (!autoAiDone) {
          autoAiDone = true;
          requestAiSummary();
        }
      }, 10000);

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += value;
        let lines = buffer.split("\n");
        buffer = lines.pop();

        for (let line of lines) {
          try {
            const raw = JSON.parse(line.trim());
            const data = {
              acc: (Number(raw.acc) > 0) ? Number(raw.acc) : lastValues.acc,
              mic: (Number(raw.mic) >= 0) ? Number(raw.mic) : lastValues.mic,
              temp:(Number(raw.temp) > 0) ? Number(raw.temp) : lastValues.temp,
              ts: Date.now()
            };
            lastValues = { ...data };
            latestData = data;

            // ìœˆë„ìš°(í‰ê· ) ê°±ì‹ 
            ['acc','mic','temp'].forEach(k => {
              windows[k].push(data[k]);
              if (windows[k].length > AVG_WINDOW_SIZE) windows[k].shift();
            });

            // UI ê°±ì‹ 
            document.getElementById('curAcc').innerText  = Math.round(data.acc);
            document.getElementById('curMic').innerText  = Math.round(data.mic);
            document.getElementById('curTemp').innerText = Math.round(data.temp);

            document.getElementById('avgAcc').innerText  = calcAvg(windows.acc).toFixed(1);
            document.getElementById('avgMic').innerText  = calcAvg(windows.mic).toFixed(1);
            document.getElementById('avgTemp').innerText = calcAvg(windows.temp).toFixed(1);

            // ì°¨íŠ¸ ê°±ì‹ 
            chartPush('acc', data.acc);
            chartPush('mic', data.mic);
            chartPush('temp', data.temp);

            // ì €ì¥
            sessionLog.push(data);
            db.ref(`class/${studentId}/current`).set(data);

            document.getElementById('btnDownload').disabled = false;
          } catch (e) {
            // íŒŒì‹± ì‹¤íŒ¨ ë¬´ì‹œ
          }
        }
      }
    }

    // ===== ë²„íŠ¼ =====
    document.getElementById('btnConnect').onclick = async () => {
      const port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      readLoop(port);
    };

    document.getElementById('btnDownload').onclick = () => {
      const blob = new Blob([sessionLog.map(JSON.stringify).join('\n')], {type:'application/jsonl'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `PHD_secure_log_${Date.now()}.jsonl`;
      a.click();
    };

    document.getElementById('btnAiRefresh').onclick = () => {
      requestAiSummary();
    };
  </script>
</body>
</html>
