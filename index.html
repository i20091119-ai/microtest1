<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°êµ¬ìš© ë°ì´í„° íŒŒì´í”„ë¼ì¸ - ì•ˆì •í™” ë²„ì „</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; padding: 20px; }
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto 20px; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 10px; text-align: center; color: white; }
        .acc-color { background: #007bff; } .mic-color { background: #6f42c1; } .temp-color { background: #fd7e14; }
        .ai-box { background: #e3f2fd; border-left: 5px solid #1976d2; padding: 15px; margin-top: 10px; border-radius: 8px; min-height: 50px; }
        canvas { max-height: 180px; }
        button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="panel">
        <h2 style="text-align:center;">ğŸ”¬ AI-IoT ì‹¤ì‹œê°„ ë¶„ì„ (ì•ˆì •í™” ë²„ì „)</h2>
        <div style="text-align:center; margin-bottom:20px;">
            <button id="btnConnect" style="background:#007bff; color:white;">ê¸°ê¸° ì—°ê²°</button>
            <button id="btnDownload" style="background:#28a745; color:white; margin-left:10px;" disabled>ë°ì´í„° ì €ì¥</button>
        </div>
        
        <div class="stats-row">
            <div class="stat-card acc-color">ê°€ì†ë„ (5s Avg)<br><b id="avgAcc">0.0</b><br><small>í˜„ì¬: <span id="curAcc">0</span></small></div>
            <div class="stat-card mic-color">ì†ŒìŒ (5s Avg)<br><b id="avgMic">0.0</b><br><small>í˜„ì¬: <span id="curMic">0</span></small></div>
            <div class="stat-card temp-color">ì˜¨ë„ (5s Avg)<br><b id="avgTemp">0.0</b><br><small>í˜„ì¬: <span id="curTemp">0</span></small></div>
        </div>

        <div class="ai-box">
            <strong>ğŸ¤– AI ë¶„ì„ ê²°ê³¼:</strong>
            <p id="aiReport">ë°ì´í„° ì „ì†¡ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>

    <div class="panel"><canvas id="accChart"></canvas></div>
    <div class="panel"><canvas id="micChart"></canvas></div>
    <div class="panel"><canvas id="tempChart"></canvas></div>

    <script>
        // [í•„ë…] ì£¼ì†Œ ëì— '/'ê°€ ìˆìœ¼ë©´ ì œê±°í•˜ì„¸ìš”.
        const firebaseConfig = { databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com" };
        const GEMINI_API_KEY = "AIzaSyBAsD0zi_FndXgihSx-c2sBb_6Xtmj33aI";
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const studentId = "Researcher_1"; 

        let sessionLog = [];
        let windows = { acc: [], mic: [], temp: [] };
        let lastAiTime = 0;
        let isAiCalling = false; // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        const charts = {};
        function setupCharts() {
            const config = (label, color, min, max) => ({
                type: 'line',
                data: { labels: new Array(50).fill(""), datasets: [{ label, data: new Array(50).fill(null), borderColor: color, tension: 0.1, pointRadius: 0 }] },
                options: { scales: { y: { min, max } }, animation: false, responsive: true, maintainAspectRatio: false }
            });
            charts.acc = new Chart(document.getElementById('accChart'), config('ê°€ì†ë„(mg)', '#007bff', 500, 2500));
            charts.mic = new Chart(document.getElementById('micChart'), config('ì†ŒìŒ(level)', '#6f42c1', 0, 255));
            charts.temp = new Chart(document.getElementById('tempChart'), config('ì˜¨ë„(Â°C)', '#fd7e14', 10, 45));
        }
        setupCharts();

        async function runAI(summary) {
            // 15ì´ˆ ê°„ê²© & ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
            if (Date.now() - lastAiTime < 15000 || isAiCalling) return; 
            isAiCalling = true;
            lastAiTime = Date.now();
            document.getElementById('aiReport').innerText = "Gemini AIê°€ ìƒí™©ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...";

            const promptText = `ì„¼ì„œ ë°ì´í„°: ê°€ì†ë„ ${summary.acc}, ì†ŒìŒ ${summary.mic}, ì˜¨ë„ ${summary.temp}. ì´ ìˆ˜ì¹˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ í˜„ì¬ ì¥ë¹„ì˜ ìƒíƒœë‚˜ ì—°êµ¬ì‹¤ í™˜ê²½ì„ ì•„ì£¼ ì§§ê²Œ(30ì ë‚´ì™¸) í•´ì„í•´ì¤˜.`;
            
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const res = await resp.json();
                const comment = res.candidates[0].content.parts[0].text.trim();
                document.getElementById('aiReport').innerText = comment;
                db.ref(`class/${studentId}/ai_comment`).set(comment);
            } catch(e) { 
                console.error("AI API Error:", e);
                document.getElementById('aiReport').innerText = "AI ë¶„ì„ ì§€ì—° ì¤‘...";
            } finally {
                isAiCalling = false;
            }
        }

        async function readLoop(port) {
            const reader = port.readable.pipeThrough(new TextDecoderStream()).getReader();
            let buffer = "";
            document.getElementById('btnConnect').innerText = "ì—°ê²° ì™„ë£Œ";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                buffer += value;
                let lines = buffer.split(/\r?\n/); // ì¤„ë°”ê¿ˆ ì•ˆì •ì  ì²˜ë¦¬
                buffer = lines.pop(); 

                for (let line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed) continue;
                    
                    try {
                        const raw = JSON.parse(trimmed);
                        const ts = Date.now();
                        const processed = { ...raw, analysis: {}, ts };
                        
                        ['acc', 'mic', 'temp'].forEach(k => {
                            windows[k].push(raw[k]);
                            if(windows[k].length > 50) windows[k].shift();
                            
                            // NaN ë°©ì§€: ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ í‰ê·  ê³„ì‚°
                            const avg = windows[k].length > 0 
                                ? (windows[k].reduce((a,b)=>a+b,0) / windows[k].length).toFixed(1)
                                : 0.0;

                            processed.analysis[k+'_avg'] = avg;
                            document.getElementById('cur'+k.charAt(0).toUpperCase()+k.slice(1)).innerText = raw[k];
                            document.getElementById('avg'+k.charAt(0).toUpperCase()+k.slice(1)).innerText = avg;
                            
                            // ê·¸ë˜í”„ ëŠê¹€ ë°©ì§€
                            charts[k].data.datasets[0].data.push(raw[k]);
                            charts[k].data.datasets[0].data.shift();
                            charts[k].update('none'); // ì„±ëŠ¥ ìµœì í™”
                        });

                        sessionLog.push(processed);
                        db.ref(`class/${studentId}/current`).set(processed);
                        runAI(raw);
                        document.getElementById('btnDownload').disabled = false;
                    } catch(e) {
                        // ë¶ˆì™„ì „í•œ JSON ë°ì´í„°ëŠ” ë¬´ì‹œ
                    }
                }
            }
        }

        document.getElementById('btnConnect').onclick = async () => {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            readLoop(port);
        };

        document.getElementById('btnDownload').onclick = () => {
            if (sessionLog.length === 0) return;
            const blob = new Blob([sessionLog.map(JSON.stringify).join('\n')], {type: 'application/jsonl'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `research_data_${Date.now()}.jsonl`;
            a.click();
        };
    </script>
</body>
</html>
