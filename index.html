<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PHD Lab - ì‹¤ì‹œê°„ ë¶„ì„ ì‹œìŠ¤í…œ (Throttle)</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; background: #f0f4f8; padding: 20px; color: #333; }
    .panel { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { padding: 15px; border-radius: 12px; text-align: center; color: white; position: relative; }
    .acc-color { background: #007bff; } .mic-color { background: #6f42c1; } .temp-color { background: #fd7e14; }
    .stat-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; display: block; }
    .stat-main { font-size: 1.8rem; font-weight: 800; display: block; }
    .stat-sub { font-size: 0.9rem; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; display: block; }
    .ai-box { background: #e3f2fd; border-left: 5px solid #1976d2; padding: 15px; border-radius: 8px; font-weight: 500; }
    canvas { max-height: 160px; width: 100% !important; }
    .controls { text-align: center; margin-bottom: 20px; }
    button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button:active { transform: scale(0.95); }
  </style>
</head>
<body>

<div class="panel">
  <h2 style="text-align:center; margin-top:0;">ğŸ“¡ ë©€í‹°ì„¼ì„œ ì‹¤ì‹œê°„ ë¶„ì„ íŒŒì´í”„ë¼ì¸</h2>
  <div class="controls">
    <button id="btnConnect" style="background:#007bff; color:white;">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°</button>
    <button id="btnDownload" style="background:#28a745; color:white; margin-left:10px;" disabled>ë¡œê·¸ ì €ì¥ (JSONL)</button>
  </div>

  <div class="stats-grid">
    <div class="stat-card acc-color">
      <span class="stat-label">ê°€ì†ë„ (Acc)</span>
      <span class="stat-main" id="curAcc">0</span>
      <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgAcc">0.0</span></span>
    </div>
    <div class="stat-card mic-color">
      <span class="stat-label">ì†ŒìŒ (Mic)</span>
      <span class="stat-main" id="curMic">0</span>
      <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgMic">0.0</span></span>
    </div>
    <div class="stat-card temp-color">
      <span class="stat-label">ì˜¨ë„ (Temp)</span>
      <span class="stat-main" id="curTemp">0</span>
      <span class="stat-sub">5ì´ˆ í‰ê· : <span id="avgTemp">0.0</span></span>
    </div>
  </div>

  <div class="ai-box">
    ğŸ¤– <strong>AI Insight:</strong> <span id="aiReport" style="font-weight: 400;">(ì¼ë‹¨ ë¹„í™œì„±) ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</span>
  </div>
</div>

<div class="panel"><canvas id="accChart"></canvas></div>
<div class="panel"><canvas id="micChart"></canvas></div>
<div class="panel"><canvas id="tempChart"></canvas></div>

<script>
  // ===== 0) ì£¼ê¸°(Throttle) ì„¤ì • =====
  const UI_INTERVAL_MS      = 100;   // UI 10Hz
  const CHART_INTERVAL_MS   = 200;   // ì°¨íŠ¸ 5Hz
  const FIREBASE_INTERVAL_MS= 1000;  // Firebase 1Hz
  const AVG_WINDOW_SIZE     = 50;    // micro:bit 150ms ê¸°ì¤€ ì•½ 7.5ì´ˆ. (ì›í•˜ë©´ 33 ì •ë„ë¡œ ì¤„ì—¬ 5ì´ˆ ê·¼ì ‘)

  // ===== 1) ì´ˆê¸° ì„¤ì • =====
  const firebaseConfig = { databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const studentId = "Researcher_1";

  // ===== 2) ìƒíƒœ ë³€ìˆ˜ =====
  let sessionLog = [];
  let latestData = null;          // <- íŒŒì‹± ë£¨í”„ê°€ ì—¬ê¸°ì—ë§Œ ìµœì‹ ê°’ ì €ì¥
  let lastGood   = { acc: 1000, mic: 0, temp: 25, ts: Date.now() };

  // ì´ë™í‰ê· (ëˆ„ì í•© ë°©ì‹)
  const win = {
    acc: { arr: [], sum: 0 },
    mic: { arr: [], sum: 0 },
    temp:{ arr: [], sum: 0 },
  };

  // ì°¨íŠ¸ ë°ì´í„°(ê³ ì • ê¸¸ì´)
  const charts = {};
  const chartLen = 40;

  function setupCharts() {
    const make = (label, color, min, max, elId) => new Chart(document.getElementById(elId), {
      type: 'line',
      data: {
        labels: new Array(chartLen).fill(""),
        datasets: [{
          label,
          data: new Array(chartLen).fill(null),
          borderColor: color,
          tension: 0.2,
          pointRadius: 0,
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        animation: false,
        maintainAspectRatio: false,
        scales: {
          y: { min, max, ticks: { display: true } },
          x: { display: false }
        }
      }
    });

    charts.acc  = make('ê°€ì†ë„(mg)', '#007bff', 800, 1200, 'accChart');
    charts.mic  = make('ì†ŒìŒ(lvl)',  '#6f42c1', 0,   150,  'micChart');
    charts.temp = make('ì˜¨ë„(Â°C)',   '#fd7e14', 15,  40,   'tempChart');
  }
  setupCharts();

  function pushAvg(key, v) {
    const w = win[key];
    w.arr.push(v);
    w.sum += v;
    if (w.arr.length > AVG_WINDOW_SIZE) {
      w.sum -= w.arr.shift();
    }
    return (w.sum / w.arr.length);
  }

  // ===== 3) Serial ì½ê¸°(íŒŒì‹±) ë£¨í”„: ì—¬ê¸°ì„œëŠ” "ì €ì¥ë§Œ" =====
  async function readLoop(port) {
    const reader = port.readable.pipeThrough(new TextDecoderStream()).getReader();
    let buffer = "";
    document.getElementById('btnConnect').innerText = "Streaming...";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buffer += value;

      const lines = buffer.split("\n");
      buffer = lines.pop();

      for (const line of lines) {
        const s = line.trim();
        if (!s) continue;

        try {
          const raw = JSON.parse(s);

          // ë³´ì •: ê°’ ì´ìƒí•˜ë©´ ì§ì „ ì •ìƒê°’ ì‚¬ìš©
          const acc  = (Number(raw.acc)  > 0) ? Number(raw.acc)  : lastGood.acc;
          const mic  = (Number(raw.mic) >= 0) ? Number(raw.mic)  : lastGood.mic;
          const temp = (Number(raw.temp) > 0) ? Number(raw.temp) : lastGood.temp;

          const data = { acc, mic, temp, ts: Date.now() };

          lastGood = data;
          latestData = data;      // <- ìµœì‹ ê°’ë§Œ ê°±ì‹ 
          sessionLog.push(data);  // <- ë¡œê·¸ëŠ” ê³„ì† ìŒ“ë˜, UI/ì°¨íŠ¸/DBëŠ” íƒ€ì´ë¨¸ì—ì„œ ì²˜ë¦¬

          document.getElementById('btnDownload').disabled = false;
        } catch (e) {
          // íŒŒì‹± ì‹¤íŒ¨ ë¼ì¸ì€ ë¬´ì‹œ
        }
      }
    }
  }

  // ===== 4) UI ì—…ë°ì´íŠ¸(10Hz) =====
  setInterval(() => {
    if (!latestData) return;

    const { acc, mic, temp } = latestData;

    document.getElementById('curAcc').innerText  = Math.round(acc);
    document.getElementById('curMic').innerText  = Math.round(mic);
    document.getElementById('curTemp').innerText = Math.round(temp);

    const a = pushAvg('acc', acc);
    const m = pushAvg('mic', mic);
    const t = pushAvg('temp', temp);

    document.getElementById('avgAcc').innerText  = a.toFixed(1);
    document.getElementById('avgMic').innerText  = m.toFixed(1);
    document.getElementById('avgTemp').innerText = t.toFixed(1);
  }, UI_INTERVAL_MS);

  // ===== 5) ì°¨íŠ¸ ì—…ë°ì´íŠ¸(5Hz) =====
  setInterval(() => {
    if (!latestData) return;

    const { acc, mic, temp } = latestData;

    const upd = (key, v) => {
      const ds = charts[key].data.datasets[0].data;
      ds.push(v);
      if (ds.length > chartLen) ds.shift();
      charts[key].update('none');
    };

    upd('acc', acc);
    upd('mic', mic);
    upd('temp', temp);
  }, CHART_INTERVAL_MS);

  // ===== 6) Firebase ì „ì†¡(1Hz) =====
  setInterval(() => {
    if (!latestData) return;
    // ìƒ˜í”Œë§ˆë‹¤ set() í•˜ì§€ ë§ê³ , 1ì´ˆì— 1ë²ˆë§Œ
    db.ref(`class/${studentId}/current`).set(latestData);
  }, FIREBASE_INTERVAL_MS);

  // ===== 7) ì—°ê²° ë²„íŠ¼ =====
  document.getElementById('btnConnect').onclick = async () => {
    const port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    readLoop(port);
  };

  // ===== 8) JSONL ì €ì¥ =====
  document.getElementById('btnDownload').onclick = () => {
    const blob = new Blob([sessionLog.map(JSON.stringify).join('\n')], { type: 'application/jsonl' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `PHD_Data_${Date.now()}.jsonl`;
    a.click();
  };

  // ===== (ë³´ë¥˜) AI ìš”ì•½ =====
  // ì§€ê¸ˆì€ ëŠê¹€ ì´ìŠˆ í•´ê²°ì´ ìš°ì„ ì´ë¼ í˜¸ì¶œ ìì²´ë¥¼ ë§‰ì•„ë‘ .
  // í•„ìš”í•˜ë©´ FIREBASE_INTERVAL_MSë³´ë‹¤ ë” ëŠë¦¬ê²Œ(ì˜ˆ: 20~30ì´ˆ) íƒ€ì´ë¨¸ë¡œ ë”°ë¡œ ëŒë¦¬ëŠ” ê²Œ ì•ˆì •ì .
</script>
</body>
</html>
