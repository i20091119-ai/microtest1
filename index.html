<!DOCTYPE html>
<html>
<head>
    <title>PHD Project - Student Node (AI Integrated)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        .status { font-weight: bold; color: #1a73e8; }
        .ai-box { background: #e8f0fe; border-left: 4px solid #1a73e8; padding: 15px; margin-top: 20px; border-radius: 4px; }
        button { background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        #data-display { font-size: 0.9rem; color: #555; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ”¬ ì—°êµ¬ì‹¤ ë‹¨ë§ê¸° (Student)</h2>
        <button onclick="connectSerial()">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°</button>
        <p>ìƒíƒœ: <span id="status" class="status">ì—°ê²° ëŒ€ê¸° ì¤‘</span></p>
        
        <div id="data-display">ìˆ˜ì§‘ ë°ì´í„°: ëŒ€ê¸° ì¤‘...</div>

        <div class="ai-box">
            <strong>ğŸ¤– AI ì‹¤ì‹œê°„ í•´ì„:</strong>
            <p id="ai-report">ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œì‘í•˜ë©´ AI ë¶„ì„ì´ ê°€ë™ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        // 1. Firebase ì„¤ì • (ë³¸ì¸ì˜ ì„¤ì •ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”)
        const firebaseConfig = {
            databaseURL: "https://your-project-id.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const studentId = "Student_A"; 
        const GEMINI_API_KEY = "AIzaSyBAsD0zi_FndXgihSx-c2sBb_6Xtmj33aI";

        let port;
        let reader;
        let buffer = "";
        let lastAiTime = 0;

        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                document.getElementById('status').innerText = "ì—°ê²°ë¨";
                readLoop();
            } catch (e) { console.error(e); }
        }

        async function readLoop() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                if (buffer.includes("\n")) {
                    const lines = buffer.split("\n");
                    const lastLine = lines[lines.length - 2];
                    buffer = lines[lines.length - 1];
                    processData(lastLine);
                }
            }
        }

        async function processData(line) {
            const data = line.trim().split(",");
            if (data.length >= 3) {
                const payload = {
                    acc: parseFloat(data[0]),
                    mic: parseFloat(data[1]),
                    temp: parseFloat(data[2]),
                    ts: Date.now()
                };

                // í™”ë©´ í‘œì‹œ ë° Firebase ì €ì¥
                document.getElementById('data-display').innerText = `ê°€ì†ë„: ${payload.acc}, ì†ŒìŒ: ${payload.mic}, ì˜¨ë„: ${payload.temp}`;
                db.ref(`class/${studentId}/current`).set(payload);

                // 10ì´ˆë§ˆë‹¤ AI í•´ì„ í˜¸ì¶œ
                if (Date.now() - lastAiTime > 10000) {
                    analyzeWithAI(payload);
                }
            }
        }

        async function analyzeWithAI(data) {
            lastAiTime = Date.now();
            document.getElementById('ai-report').innerText = "AI ë¶„ì„ ì¤‘...";

            const prompt = `ë„ˆëŠ” ì—°êµ¬ì‹¤ í™˜ê²½ ë¶„ì„ ì „ë¬¸ê°€ì•¼. ì•„ë˜ ì„¼ì„œ ë°ì´í„°ë¥¼ ë³´ê³  í˜„ì¬ ìƒí™©ì„ í•œ ì¤„(30ì ì´ë‚´)ë¡œ ìš”ì•½í•´ì¤˜.
            - ê°€ì†ë„: ${data.acc} (ì •ìƒë²”ìœ„ 1000ë‚´ì™¸)
            - ì†ŒìŒ: ${data.mic} (ë†’ì„ìˆ˜ë¡ ì‹œë„ëŸ¬ì›€)
            - ì˜¨ë„: ${data.temp}ë„
            ë¬¸ì¥ ëì€ 'í•¨', 'ì„' ë“±ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ëë‚´ì¤˜.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const result = await response.json();
                const aiText = result.candidates[0].content.parts[0].text;
                
                document.getElementById('ai-report').innerText = aiText;
                db.ref(`class/${studentId}/ai_comment`).set(aiText);
            } catch (e) {
                console.error("AI í˜¸ì¶œ ì˜¤ë¥˜", e);
            }
        }
    </script>
</body>
</html>
