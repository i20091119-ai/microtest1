<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°êµ¬ ê´€ë¦¬ì ì‹¤ì‹œê°„ ê´€ì œ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #0f172a; color: #f8fafc; padding: 20px; }
        h1 { text-align: center; color: #38bdf8; }
        
        /* ìƒë‹¨ ìš”ì•½ ë°” */
        .summary-bar { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; 
            margin-bottom: 30px; background: #1e293b; padding: 20px; border-radius: 15px;
        }
        .summary-card { text-align: center; border-right: 1px solid #334155; }
        .summary-card:last-child { border-right: none; }
        .summary-card span { font-size: 0.9rem; color: #94a3b8; }
        .summary-card div { font-size: 1.8rem; font-weight: bold; color: #38bdf8; }

        /* í•™ìƒ ì¹´ë“œ ê·¸ë¦¬ë“œ */
        #dashboard { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
            gap: 20px; 
        }
        .student-card { 
            background: #1e293b; border-radius: 12px; padding: 15px; 
            transition: all 0.3s; border: 2px solid transparent;
        }
        .student-card.alert { border-color: #ef4444; background: #450a0a; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .name { font-size: 1.2rem; font-weight: bold; color: #e2e8f0; }
        .raw-data { font-family: monospace; font-size: 0.85rem; color: #10b981; }
        
        canvas { width: 100% !important; height: 150px !important; }
        
        .stats-footer { 
            display: flex; justify-content: space-between; margin-top: 10px; 
            font-size: 0.85rem; color: #94a3b8; border-top: 1px solid #334155; padding-top: 10px;
        }
    </style>
</head>
<body>

    <h1>ğŸ›°ï¸ REAL-TIME RESEARCH CONTROL CENTER</h1>

    <div class="summary-bar">
        <div class="summary-card"><span>ì ‘ì† ì—°êµ¬ì›</span><div id="totalStudents">0</div></div>
        <div class="summary-card"><span>ì „ì²´ í‰ê·  ê°€ì†ë„</span><div id="globalAvg">0</div></div>
        <div class="summary-card"><span>ëˆ„ì  ê°ì§€ ì´ë²¤íŠ¸</span><div id="totalEvents">0</div></div>
    </div>

    <div id="dashboard">
        </div>

    <script>
        // [Firebase ì„¤ì • - í•™ìƒìš©ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€]
        const firebaseConfig = {
            apiKey: "AIzaSyCINokjlLwLlrE8Qa7SzWGm_-B1V5wr0L8",
            databaseURL: "https://microbit-lab-default-rtdb.firebaseio.com",
            projectId: "microbit-lab",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const studentCharts = {}; // í•™ìƒë³„ ì°¨íŠ¸ ê°ì²´ ì €ì¥
        let globalEventCount = 0;

        db.ref('class').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const dashboard = document.getElementById('dashboard');
            let totalAcc = 0;
            let count = 0;

            Object.keys(data).forEach(studentId => {
                const sData = data[studentId];
                totalAcc += sData.acc;
                count++;

                // 1. ì¹´ë“œ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
                let card = document.getElementById(`card-${studentId}`);
                if (!card) {
                    card = createStudentCard(studentId);
                    dashboard.appendChild(card);
                    initChart(studentId);
                }

                // 2. ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼ ë°˜ì˜ (Alert ì²˜ë¦¬)
                if (sData.analysis && sData.analysis.is_impact) {
                    card.classList.add('alert');
                    globalEventCount++;
                    setTimeout(() => card.classList.remove('alert'), 2000);
                }

                // 3. í…ìŠ¤íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                card.querySelector('.raw-acc').innerText = sData.acc;
                card.querySelector('.avg-acc').innerText = sData.analysis ? sData.analysis.rolling_avg : '-';
                card.querySelector('.timestamp').innerText = new Date(sData.server_ts).toLocaleTimeString();

                // 4. ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                updateChart(studentId, sData.acc);
            });

            // ìƒë‹¨ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('totalStudents').innerText = count;
            document.getElementById('globalAvg').innerText = (totalAcc / count).toFixed(1);
            document.getElementById('totalEvents').innerText = globalEventCount;
        });

        function createStudentCard(id) {
            const div = document.createElement('div');
            div.id = `card-${id}`;
            div.className = 'student-card';
            div.innerHTML = `
                <div class="card-header">
                    <span class="name">${id}</span>
                    <span class="raw-data">ACC: <span class="raw-acc">0</span></span>
                </div>
                <canvas id="chart-${id}"></canvas>
                <div class="stats-footer">
                    <span>ìµœê·¼í‰ê· : <b class="avg-acc">0</b></span>
                    <span class="timestamp" style="font-size:0.7rem;">-</span>
                </div>
            `;
            return div;
        }

        function initChart(id) {
            const ctx = document.getElementById(`chart-${id}`).getContext('2d');
            studentCharts[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: new Array(30).fill(""), datasets: [{ 
                    label: 'Acc Stream', 
                    data: new Array(30).fill(null), 
                    borderColor: '#38bdf8', 
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 0
                }]},
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { display: false, min: 500, max: 2500 },
                        x: { display: false }
                    },
                    plugins: { legend: { display: false } },
                    animation: false
                }
            });
        }

        function updateChart(id, value) {
            const chart = studentCharts[id];
            if (!chart) return;
            chart.data.datasets[0].data.push(value);
            chart.data.datasets[0].data.shift();
            chart.update();
        }
    </script>
</body>
</html>
